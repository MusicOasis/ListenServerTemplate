<?xml version="1.0" encoding="utf-8"?>
<root xmlns:android="http://schemas.android.com/apk/res/android">
    <trace enable="true" />
    
    <!-- Add Discord OAuth intent filter to AndroidManifest.xml -->
    <androidManifestUpdates>
        <log text="=== Starting androidManifestUpdates ==="/>
        
        <!-- Read the Application ID from Engine.ini -->
        <setStringFromProperty result="DiscordClientId" ini="Engine" section="/Script/DiscordPartnerSDK.DiscordPartnerSDKSettings" property="ApplicationIdString" default=""/>
        <log text="Discord Client ID from Engine.ini: $S(DiscordClientId)"/>
        
        <!-- Add the new Discord activity with correct client ID -->
        <log text="*** ADDING Discord AuthenticationActivity with scheme: discord-$S(DiscordClientId) ***"/>
        <addElements tag="application">
            <activity android:name="com.discord.socialsdk.AuthenticationActivity"
                      android:exported="true">
                <intent-filter>
                    <action android:name="android.intent.action.VIEW" />
                    <category android:name="android.intent.category.DEFAULT" />
                    <category android:name="android.intent.category.BROWSABLE" />
                    <data android:scheme="DISCORD_PLACEHOLDER" />
                </intent-filter>
            </activity>
        </addElements>
        
        <!-- Update the placeholder element after adding the new activity -->
        <loopElements tag="activity">
            <setStringFromAttribute result="CurrentActivityName" tag="$" name="android:name"/>
            <setBoolIsEqual result="IsDiscordAuthActivity" arg1="$S(CurrentActivityName)" arg2="com.discord.socialsdk.AuthenticationActivity"/>
            <if condition="IsDiscordAuthActivity">
                <true>
                    <log text="*** UPDATING Discord activity scheme ***"/>
                    <loopElements tag="intent-filter">
                        <loopElements tag="data">
                            <setStringFromAttribute result="CurrentScheme" tag="$" name="android:scheme"/>
                            <setBoolIsEqual result="IsPlaceholder" arg1="$S(CurrentScheme)" arg2="DISCORD_PLACEHOLDER"/>
                            <if condition="IsPlaceholder">
                                <true>
                                    <log text="*** REPLACING scheme from DISCORD_PLACEHOLDER to discord-$S(DiscordClientId) ***"/>
                                    <addAttribute tag="$" name="android:scheme" value="discord-$S(DiscordClientId)"/>
                                </true>
                            </if>
                        </loopElements>
                    </loopElements>
                </true>
            </if>
        </loopElements>        
        <log text="=== Finished androidManifestUpdates ==="/>
    </androidManifestUpdates>

    <!-- Your existing build configuration -->
    <buildGradleAdditions>
        <insert>
            configurations.all {
                resolutionStrategy {
                    force 'androidx.browser:browser:1.8.0'
                }
            }
            dependencies {
                implementation files("libs/discord_partner_sdk.aar")
                implementation 'androidx.browser:browser:1.8.0'
            }
        </insert>
    </buildGradleAdditions>
    
    <gradleCopies>
        <copyFile src="$S(PluginDir)/../../Binaries/ThirdParty/DiscordPartnerSDKLibrary/Android/discord_partner_sdk.aar"
                  dst="$S(BuildDir)/gradle/app/libs/discord_partner_sdk.aar" />
    </gradleCopies>
    
    <soLoadLibrary>
        <loadLibrary name="discord_partner_sdk" failmsg="Failed to load Discord Social SDK" />
    </soLoadLibrary>
    
    <gameActivityOnCreateBeginningAdditions>
        <insert>
            com.discord.socialsdk.DiscordSocialSdkInit.setEngineActivity(this);
        </insert>
    </gameActivityOnCreateBeginningAdditions>
</root>